#!/usr/bin/env python
import os
import sys
import glob

from tlfp.tools.common import open_json
from tlfp import parse_one


verbose = "--quiet" not in sys.argv

API_DIRECTORY = sys.argv[1]

already_done = {}
for jsondos in glob.glob(os.path.join(API_DIRECTORY, '*/viz/procedure.json')):
    dos = open_json(jsondos)
    if dos.get('url_jo'):
        already_done[dos.get('url_dossier_senat')] = True

for url in sys.stdin:
    url = url.strip()
    if url in already_done:
        if verbose:
            print()
            print('======')
            print(url)
            print('  + passed, already done:', url)
        continue
    dos = None
    try:
        dos = parse_one.process(API_DIRECTORY, url)
        if dos:
            print('SUCCESS:', url)
            print("       > https://www.lafabriquedelaloi.fr/articles.html?loi=%s" % dos.get('id'))
    except KeyboardInterrupt:
        break
    except parse_one.ParsingFailedException as e:
        print('FAILED:', url)
        print('     > ', e.root_exception)
        print('     > ', "https://www.lafabriquedelaloi.fr/api/logs/%s" % e.logfile)
